#!/usr/bin/env bash
# nmcli-wifi â€” Minimal interactive Wi-Fi manager
# Requires: NetworkManager (nmcli)

set -euo pipefail

status() {
    wifi_state="$(nmcli -t radio wifi)"
    ssid="$(
        nmcli -t -f NAME,TYPE connection show --active |
        awk -F: '$2=="802-11-wireless"{print $1}'
    )"
}

header() {
    clear
    status
    echo "=== Wi-Fi Manager ==="

    if [[ "$wifi_state" == "disabled" ]]; then
        echo "Wi-Fi: OFF"
    elif [[ -n "$ssid" ]]; then
        echo "Connected: $ssid"
    else
        echo "Wi-Fi: ON"
    fi

    echo
    echo "$1"
}

toggle() {
    status
    [[ "$wifi_state" == "enabled" ]] \
        && nmcli radio wifi off \
        || nmcli radio wifi on
}

connect() {
    echo "Connecting to: $1"
    nmcli device wifi connect "$1" --ask
}

scan_networks() {
    local i
    for i in {1..10}; do
        mapfile -t nets < <(
            nmcli -t -f SSID,SIGNAL,SECURITY device wifi list --rescan yes |
            awk -F: '$1 !~ /^[[:space:]]*$/'
        )
        (( ${#nets[@]} )) && return 0
        sleep 1
    done
    return 1
}

list_networks() {
    status

    if [[ "$wifi_state" == "disabled" ]]; then
        header "Wi-Fi is OFF"
        echo "1) Turn Wi-Fi ON"
        echo "2) Back"
        echo
        read -rp "Choice: " c

        [[ "$c" == "1" ]] || return
        toggle
    fi

    header "Searching for networks..."

    if ! scan_networks; then
        echo "No networks found."
        read -rp "Press Enter to return..." _
        return
    fi

    header "Available networks"
    printf "%-3s %-6s %-10s %s\n" "#" "SIGNAL" "SECURITY" "SSID"

    for i in "${!nets[@]}"; do
        awk -F: -v n=$((i+1)) '
            { printf "%d) %-6s %-10s %s\n",
              n, $2, ($3=="--"?"OPEN":$3), $1 }
        ' <<< "${nets[$i]}"
    done

    echo
    read -rp "Network number (or Enter to cancel): " c

    if ! [[ "$c" =~ ^[0-9]+$ ]]; then
        return
    fi

    idx=$((c - 1))
    if (( idx < 0 || idx >= ${#nets[@]} )); then
        return
    fi

    connect "${nets[$idx]%%:*}"
}

while true; do
    header "Main menu"
    echo "1) List networks"
    echo "2) Toggle Wi-Fi"
    echo "*) Exit"
    echo
    read -rp "Choice: " c

    case "$c" in
        1) list_networks ;;
        2) toggle ;;
        *) exit 0 ;;
    esac
done
