#!/usr/bin/env bash
# nmcli-wifi â€” Interactive Wi-Fi manager in Bash using nmcli
# Requirements: nmcli (NetworkManager)

set -o errexit
set -o nounset
set -o pipefail

### Utility functions

die() {
    echo "Error: $*" >&2
    exit 1
}

### Checks

command -v nmcli >/dev/null 2>&1 || die "nmcli not found"

### Wi-Fi state

wifi_state="$(nmcli -t -f WIFI general)"

if [[ "$wifi_state" == "disabled" ]]; then
    clear
    echo "=== Wi-Fi Manager ==="
    echo
    echo "Wi-Fi is turned off."
    echo
    echo "1) Enable Wi-Fi"
    echo "2) Exit"
    echo

    read -rp "Choose an option: " opt

    case "$opt" in
        1)
            echo "Enabling Wi-Fi..."
            nmcli radio wifi on
            sleep 5
            ;;
        2)
            exit 0
            ;;
        *)
            die "Invalid option"
            ;;
    esac
fi

### Active Wi-Fi network

current_ssid="$(
    nmcli -t -f NAME,TYPE connection show --active \
    | awk -F: '$2=="802-11-wireless" {print $1}'
)"

### List networks

clear
echo "=== Wi-Fi Manager ==="
echo "Scanning available networks..."
echo

mapfile -t WIFI_LIST < <(
    nmcli -t -f SIGNAL,SECURITY,SSID device wifi list \
    | awk -F: '
        $3 != "" {
            signal=$1
            if ($2 ~ /WPA|WEP/) sec="(secured)"
            else sec="(open)"
            printf "%s|%s|%s%%\n", $3, sec, signal
        }
    ' | sort -t'|' -k1,1 -u
)

### Menu

clear
echo "=== Wi-Fi Manager ==="
echo

if [[ -n "$current_ssid" ]]; then
    echo "Connected to network: $current_ssid"
else
    echo "No Wi-Fi network connected"
fi

echo

i=1
for entry in "${WIFI_LIST[@]}"; do
    ssid="${entry%%|*}"
    rest="${entry#*|}"
    sec="${rest%%|*}"
    signal="${rest##*|}"
    printf "%d) %-30s %-12s %4s\n" "$i" "$ssid" "$sec" "$signal"
    ((i++))
done

if [[ -n "$current_ssid" ]]; then
    opt_disconnect="$i"
    echo "${opt_disconnect}) Disconnect Wi-Fi"
    ((i++))
fi

opt_disable="$i"
echo "${opt_disable}) Disable Wi-Fi"
((i++))

opt_cancel="$i"
echo "${opt_cancel}) Cancel"

echo
read -rp "Choose an option: " choice

### Process choice

[[ "$choice" =~ ^[0-9]+$ ]] || die "Invalid option"

if [[ -n "$current_ssid" && "$choice" -eq "$opt_disconnect" ]]; then
    nmcli con down id "$current_ssid" >/dev/null
    echo "Disconnected from network '$current_ssid'"
    exit 0
fi

if [[ "$choice" -eq "$opt_disable" ]]; then
    nmcli radio wifi off
    echo "Wi-Fi disabled"
    exit 0
fi

if [[ "$choice" -eq "$opt_cancel" ]]; then
    exit 0
fi

index=$((choice - 1))
[[ "$index" -ge 0 && "$index" -lt "${#WIFI_LIST[@]}" ]] || die "Invalid option"

ssid="${WIFI_LIST[$index]%%|*}"

### Connect

echo
echo "Connecting to network: $ssid"

# Try to connect without password (open or saved network)
if nmcli device wifi connect "$ssid" >/dev/null 2>&1; then
    echo "Connected successfully"
    exit 0
fi

# Ask for password only if required
read -rsp "Wi-Fi password: " wifi_password
echo

if nmcli device wifi connect "$ssid" password "$wifi_password" >/dev/null 2>&1; then
    echo "Connected successfully"
else
    die "Failed to connect: incorrect password or authentication error"
fi
